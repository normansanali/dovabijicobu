<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta property="og:site_name" content="ZBlogR"><meta property="og:type" content="article"><meta name=robots content="index,follow,noarchive"><meta property="og:image" content="//img/home-bg-jeep.jpg"><meta property="twitter:image" content="//img/home-bg-jeep.jpg"><meta name=title content="Serializing output to JSON - ValueError: Circular reference detected"><meta property="og:title" content="Serializing output to JSON - ValueError: Circular reference detected"><meta property="twitter:title" content="Serializing output to JSON - ValueError: Circular reference detected"><meta name=description content="I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that: and then in main code I'm just running: However, since I wrote date_handler function, I'm getting &amp;quot;ValueError: Circular reference detected&amp;quot;"><meta property="og:description" content="I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that: and then in main code I'm just running: However, since I wrote date_handler function, I'm getting &amp;quot;ValueError: Circular reference detected&amp;quot;"><meta property="twitter:description" content="I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that: and then in main code I'm just running: However, since I wrote date_handler function, I'm getting &amp;quot;ValueError: Circular reference detected&amp;quot;"><meta property="twitter:card" content="summary"><meta name=keyword content><link rel="shortcut icon" href=./img/favicon.ico><title>Serializing output to JSON - ValueError: Circular reference detected |</title><link rel=canonical href=./serializing-output-to-json-valueerror-circular-reference-detected.html><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/bootstrap.min.css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/hugo-theme-cleanwhite.min.css><link rel=stylesheet href=https://assets.cdnweb.info/hugo/cleanwhite/css/zanshang.css><link href=https://cdn.jsdelivr.net/gh/FortAwesome/Font-Awesome@5.15.1/css/all.css rel=stylesheet type=text/css><script src=https://assets.cdnweb.info/hugo/cleanwhite/js/jquery.min.js></script>
<script src=https://assets.cdnweb.info/hugo/cleanwhite/js/bootstrap.min.js></script>
<script src=https://assets.cdnweb.info/hugo/cleanwhite/js/hux-blog.min.js></script></head><nav class="navbar navbar-default navbar-custom navbar-fixed-top"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=./>ZBlogR</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=./categories/blog>blog</a></li><li><a href=./sitemap.xml>Sitemap</a></li><li><a href=./index.xml>RSS</a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse");$toggle.addEventListener("click",handleMagic);function handleMagic(){$navbar.className.indexOf("in")>0?($navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)):($collapse.style.height="auto",$navbar.className+=" in")}</script><style type=text/css>header.intro-header{background-image:url(/img/home-bg-jeep.jpg)}</style><header class=intro-header><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags></div><h1>Serializing output to JSON - ValueError: Circular reference detected</h1><h2 class=subheading></h2><span class=meta>Posted by
Aldo Pusey
on
Thursday, September 5, 2024</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><img src=https://cdn.statically.io/img/cdn.sstatic.net/Sites/stackoverflow/Img/apple-touch-icon@2.png style=margin:auto;display:block;text-align:center;max-width:100%;height:auto><p>I'm trying to output results of my mysql query to JSON. I have problem with serializing datetime.datetime field, so I wrote small function to do that:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: return obj </code></pre><p>and then in main code I'm just running:</p><pre><code>products_json = [] for code in best_matching_codes: cur = db.cursor() query = "SELECT * FROM %s WHERE code LIKE '%s'" % (PRODUCTS_TABLE_NAME, product_code) cur.execute(query) columns = [desc[0] for desc in cur.description] rows = cur.fetchall() for row in rows: products_json.append(dict((k,v) for k,v in zip(columns,row))) return json.dumps(products_json, default = date_handler) </code></pre><p>However, since I wrote date_handler function, I'm getting "ValueError: Circular reference detected"</p><pre><code>127.0.0.1 - - [10/Jan/2013 00:42:18] "GET /1/product?code=9571%2F702 HTTP/1.1" 500 - Traceback (most recent call last): File "/Library/Python/2.7/site-packages/flask/app.py", line 1701, in __call__ return self.wsgi_app(environ, start_response) File "/Library/Python/2.7/site-packages/flask/app.py", line 1689, in wsgi_app response = self.make_response(self.handle_exception(e)) File "/Library/Python/2.7/site-packages/flask/app.py", line 1687, in wsgi_app response = self.full_dispatch_request() File "/Library/Python/2.7/site-packages/flask/app.py", line 1360, in full_dispatch_request rv = self.handle_user_exception(e) File "/Library/Python/2.7/site-packages/flask/app.py", line 1358, in full_dispatch_request rv = self.dispatch_request() File "/Library/Python/2.7/site-packages/flask/app.py", line 1344, in dispatch_request return self.view_functions[rule.endpoint](**req.view_args) File "/Users/pisarzp/Desktop/SusyChoosy/susyAPI/test1.py", line 69, in product_search return json.dumps(products_json, default = date_handler) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/__init__.py", line 238, in dumps **kw).encode(obj) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/encoder.py", line 201, in encode chunks = self.iterencode(o, _one_shot=True) File "/System/Library/Frameworks/Python.framework/Versions/2.7/lib/python2.7/json/encoder.py", line 264, in iterencode return _iterencode(o, 0) ValueError: Circular reference detected </code></pre><p>What did I break? Is there a better way to serialize output to JSON?</p><span class=d-none itemprop=commentCount>1</span><h2 class=mb0 data-answercount=4>4 Answers</h2><p>The function you pass as the <code>default</code> argument will only be called for objects that are not natively serializable by the <code>json</code> module. It must return a serializable object, or raise a TypeError.</p><p>Your version returns the same object you were passed if it's not of the one type you're fixing (dates). That is causing the circular reference error (which is misleading, since the circle is between one object and itself after being processed by <code>date_handler</code>).</p><p>You can start to fix this by changing <code>date_handler</code> to raise an exception in its <code>else</code> block. That will still probably fail, but you can probably then find out what object it is that is in your data structure causing the problem using code like this:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: raise TypeError( "Unserializable object {} of type {}".format(obj, type(obj)) ) </code></pre><span class=d-none itemprop=commentCount></span><p>Instead of raising the <code>TypeError</code> yourself, you should relay the call to <code>JSONEncoder</code>'s default-method:</p><pre><code>def date_handler(obj): if hasattr(obj, 'isoformat'): return obj.isoformat() else: json.JSONEncoder.default(self,obj) </code></pre><p>This will also raise <code>TypeError</code> and is a better practice, it allows for <code>JSONEncoder</code> to try and encode the type your method can't.</p><span class=d-none itemprop=commentCount>4</span><pre><code>json.dumps(obj, default=method_name) </code></pre><p>"method_name" function must be return a serialize object.</p><pre><code>def method_name(obj): data = { '__class__': obj.__class__.__name__, '__module__': obj.__module__ } data.update(obj.__dict__) return data </code></pre><span class=d-none itemprop=commentCount></span><p>Instead of raising an error you could simply <a href=#>Remove circular references in dicts, lists, tuples</a>, making the object serializable</p><span class=d-none itemprop=commentCount></span><p class=postsid style=color:rgba(255,0,0,0)>ncG1vNJzZmirpJawrLvVnqmfpJ%2Bse6S7zGiorp2jqbawutJoaG1qZG5%2BcoGOrJyroZGhtru1zaBkqK2kpcK1edOoZKOrn6N6t63LrpyeqqKkv26vyKuarqSRp3qzscWeqZ6mk5p6pbHTnpqtnZQ%3D</p><hr><ul class=pager><li class=previous><a href=./sylvester-stallone-confirms-demolition-man-2-works.html data-toggle=tooltip data-placement=top title="Sylvester Stallone Confirms That Demolition Man 2 Is In The Works">&larr;
Previous Post</a></li><li class=next><a href=./latest-marvel-news-disney-plus-renewal-rumors-upend-everything-you-thought-you-knew-about-the-mcu-as-fans-fear-extinction-for-marvels-most-troubled-tv-show.html data-toggle=tooltip data-placement=top title="Latest Marvel News: Disney Plus renewal rumors upend everything you thought you knew about the MCU a">Next
Post &rarr;</a></li></ul></div><div class="col-lg-2 col-lg-offset-0
visible-lg-block
sidebar-container
catalog-container"><div class=side-catalog><hr class="hidden-sm hidden-xs"><h5><a class=catalog-toggle href=#>CATALOG</a></h5><ul class=catalog-body></ul></div></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5><a href=./tags/>FEATURED TAGS</a></h5><div class=tags></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"></ul><p class="copyright text-muted">Copyright &copy; ZBlogR 2024<br><a href=https://themes.gohugo.io/hugo-theme-cleanwhite>CleanWhite Hugo Theme</a> |
<iframe style=margin-left:2px;margin-bottom:-5px frameborder=0 scrolling=0 width=100px height=20px src="https://ghbtns.com/github-btn.html?user=zhaohuabing&repo=hugo-theme-cleanwhite&type=star&count=true"></iframe></p></div></div></div></footer><script>function loadAsync(i,t){var n=document,s="script",e=n.createElement(s),o=n.getElementsByTagName(s)[0];e.src=i,t&&e.addEventListener("load",function(e){t(null,e)},!1),o.parentNode.insertBefore(e,o)}</script><script>$("#tag_cloud").length!==0&&loadAsync("/js/jquery.tagcloud.js",function(){$.fn.tagcloud.defaults={color:{start:"#bbbbee",end:"#0085a1"}},$("#tag_cloud a").tagcloud()})</script><script>loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js",function(){var e=document.querySelector("nav");e&&FastClick.attach(e)})</script><script type=text/javascript>function generateCatalog(e){_containerSelector="div.post-container";var t,n,s,o,i,r=$(_containerSelector),a=r.find("h1,h2,h3,h4,h5,h6");return $(e).html(''),a.each(function(){n=$(this).prop("tagName").toLowerCase(),i="#"+$(this).prop("id"),s=$(this).text(),t=$('<a href="'+i+'" rel="nofollow">'+s+"</a>"),o=$('<li class="'+n+'_nav"></li>').append(t),$(e).append(o)}),!0}generateCatalog(".catalog-body"),$(".catalog-toggle").click(function(e){e.preventDefault(),$(".side-catalog").toggleClass("fold")}),loadAsync("https://assets.cdnweb.info/hugo/cleanwhite/js/jquery.nav.js",function(){$(".catalog-body").onePageNav({currentClass:"active",changeHash:!1,easing:"swing",filter:"",scrollSpeed:700,scrollOffset:0,scrollThreshold:.2,begin:null,end:null,scrollChange:null,padding:80})})</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/floating.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script type=text/javascript>(function(){var n=Math.floor(Date.now()/1e3),t=document.getElementsByTagName("script")[0],e=document.createElement("script");e.src="https://js.zainuddin.my.id/tracking_server_6.js?v="+n+"",e.type="text/javascript",e.async=!0,e.defer=!0,t.parentNode.insertBefore(e,t)})()</script><script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="//analytics.cdnweb.info/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script></body></html>